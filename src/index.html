<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caswino</title>
</head>
<body>
    <main>
        <div class="content">
            <div class="header">
                <img class="logo" src="./assets/logo.svg">
                <p class="text"></p>
            </div>
            
            <!-- Прогресс бар теперь в основном контейнере -->
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
        </div>
        <img class="hand" src="./assets/hand.png" alt="hand">
        <img id="chest" src="./shaking1.png" alt="chest" />
    </main>

    <script type="module" src="./main.js"></script>

        <script>
        (function () {
            // UI
            const pre = document.createElement('pre');
            pre.id = 'dev-log';
            pre.style.cssText = 'position:fixed;left:8px;bottom:8px;right:8px;max-height:220px;overflow:auto;background:rgba(0,0,0,0.8);color:#0ff;padding:8px;border-radius:6px;z-index:9999;font-size:12px';
            pre.textContent = 'logs:\n';
            document.body.appendChild(pre);

            const btnWrap = document.createElement('div');
            btnWrap.style.cssText = 'position:fixed;left:8px;top:8px;z-index:9999;display:flex;gap:6px';
            document.body.appendChild(btnWrap);

            function makeBtn(text, onClick) {
                const b = document.createElement('button');
                b.textContent = text;
                b.style.cssText = 'padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:#fff';
                b.addEventListener('click', onClick);
                btnWrap.appendChild(b);
                return b;
            }

            const simBtn = makeBtn('Simulate shake', () => {
                log('simulate shake');
                window.dispatchEvent(new Event('shake'));
            });
            const copyBtn = makeBtn('Copy logs', async () => {
                try { await navigator.clipboard.writeText(pre.textContent); log('logs copied'); } catch (e) { log('copy failed: ' + e.message); }
            });

            const permBtn = makeBtn('Request motion (iOS)', async () => {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    try {
                        const p = await DeviceMotionEvent.requestPermission();
                        log('permission: ' + p);
                        if (p === 'granted') startListeners();
                    } catch (err) { log('perm error: ' + err.message); }
                } else {
                    log('requestPermission not required');
                    startListeners();
                }
            });

            function log(s) {
                pre.textContent += '[' + new Date().toLocaleTimeString() + '] ' + s + '\n';
                pre.scrollTop = pre.scrollHeight;
                console.log(s);
            }

            // shake detection simple: dispatch 'shake' on big delta
            let lastPower = null;
            function handleAccel(a) {
                const x = a.x || 0, y = a.y || 0, z = a.z || 0;
                const power = Math.sqrt(x * x + y * y + z * z);
                log(`acc x:${x.toFixed(2)} y:${y.toFixed(2)} z:${z.toFixed(2)} power:${power.toFixed(2)}`);
                if (lastPower !== null && Math.abs(power - lastPower) > 4) {
                    log('shake detected (delta ' + Math.abs(power - lastPower).toFixed(2) + ')');
                    window.dispatchEvent(new Event('shake'));
                }
                lastPower = power;
            }

            // listeners
            function startListeners() {
                if ('ondevicemotion' in window) {
                    window.addEventListener('devicemotion', e => {
                        const acc = (e.acceleration && e.acceleration.x !== null) ? e.acceleration : e.accelerationIncludingGravity;
                        if (acc) handleAccel(acc);
                    }, { passive: true });
                    log('devicemotion listener attached');
                } else if ('ondeviceorientation' in window) {
                    // fallback: use orientation deltas
                    let last = null;
                    window.addEventListener('deviceorientation', e => {
                        const v = (e.beta || 0) + (e.gamma || 0);
                        if (last !== null && Math.abs(v - last) > 20) {
                            log('deviceorientation shake-like delta ' + Math.abs(v - last).toFixed(1));
                            window.dispatchEvent(new Event('shake'));
                        }
                        last = v;
                    }, { passive: true });
                    log('deviceorientation listener attached (fallback)');
                } else {
                    log('no motion/orientation support in this browser/context');
                }
            }

            // auto-start on non-iOS (iOS requires user gesture)
            if (!(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function')) {
                startListeners();
            } else {
                log('iOS detected — press Request motion (iOS) to enable sensors');
            }

            // example reaction to shake
            window.addEventListener('shake', () => {
                log('shake event received');
                // place your reaction here, e.g. animate chest or increment progress
            });

        })();
    </script>
    <script>
        (function () {
            // UI
            const pre = document.createElement('pre');
            pre.id = 'dev-log';
            pre.style.cssText = 'position:fixed;left:8px;bottom:8px;right:8px;max-height:220px;overflow:auto;background:rgba(0,0,0,0.8);color:#0ff;padding:8px;border-radius:6px;z-index:9999;font-size:12px';
            pre.textContent = 'logs:\n';
            document.body.appendChild(pre);

            const btnWrap = document.createElement('div');
            btnWrap.style.cssText = 'position:fixed;left:8px;top:8px;z-index:9999;display:flex;gap:6px';
            document.body.appendChild(btnWrap);

            function makeBtn(text, onClick) {
                const b = document.createElement('button');
                b.textContent = text;
                b.style.cssText = 'padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:#fff';
                b.addEventListener('click', onClick);
                btnWrap.appendChild(b);
                return b;
            }

            const simBtn = makeBtn('Simulate shake', () => {
                log('simulate shake');
                window.dispatchEvent(new Event('shake'));
            });
            const copyBtn = makeBtn('Copy logs', async () => {
                try { await navigator.clipboard.writeText(pre.textContent); log('logs copied'); } catch (e) { log('copy failed: ' + e.message); }
            });

            const permBtn = makeBtn('Request motion (iOS)', async () => {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    try {
                        const p = await DeviceMotionEvent.requestPermission();
                        log('permission: ' + p);
                        if (p === 'granted') startListeners();
                    } catch (err) { log('perm error: ' + err.message); }
                } else {
                    log('requestPermission not required');
                    startListeners();
                }
            });

            function log(s) {
                pre.textContent += '[' + new Date().toLocaleTimeString() + '] ' + s + '\n';
                pre.scrollTop = pre.scrollHeight;
                console.log(s);
            }

            // shake detection simple: dispatch 'shake' on big delta
            let lastPower = null;
            function handleAccel(a) {
                const x = a.x || 0, y = a.y || 0, z = a.z || 0;
                const power = Math.sqrt(x * x + y * y + z * z);
                log(`acc x:${x.toFixed(2)} y:${y.toFixed(2)} z:${z.toFixed(2)} power:${power.toFixed(2)}`);
                if (lastPower !== null && Math.abs(power - lastPower) > 4) {
                    log('shake detected (delta ' + Math.abs(power - lastPower).toFixed(2) + ')');
                    window.dispatchEvent(new Event('shake'));
                }
                lastPower = power;
            }

            // listeners
            function startListeners() {
                if ('ondevicemotion' in window) {
                    window.addEventListener('devicemotion', e => {
                        const acc = (e.acceleration && e.acceleration.x !== null) ? e.acceleration : e.accelerationIncludingGravity;
                        if (acc) handleAccel(acc);
                    }, { passive: true });
                    log('devicemotion listener attached');
                } else if ('ondeviceorientation' in window) {
                    // fallback: use orientation deltas
                    let last = null;
                    window.addEventListener('deviceorientation', e => {
                        const v = (e.beta || 0) + (e.gamma || 0);
                        if (last !== null && Math.abs(v - last) > 20) {
                            log('deviceorientation shake-like delta ' + Math.abs(v - last).toFixed(1));
                            window.dispatchEvent(new Event('shake'));
                        }
                        last = v;
                    }, { passive: true });
                    log('deviceorientation listener attached (fallback)');
                } else {
                    log('no motion/orientation support in this browser/context');
                }
            }

            // auto-start on non-iOS (iOS requires user gesture)
            if (!(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function')) {
                startListeners();
            } else {
                log('iOS detected — press Request motion (iOS) to enable sensors');
            }

            // example reaction to shake
            window.addEventListener('shake', () => {
                log('shake event received');
                // place your reaction here, e.g. animate chest or increment progress
            });

        })();
    </script>
</body>
</html>